<!-- templates/registration/register.html - FIXED VERSION -->
{% extends 'base.html' %}

{% block title %}Register - Josephite Tech Carnival 2025{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-800 mb-4">
            <i class="fas fa-user-plus text-primary mr-2"></i>
            Register for Tech Carnival 2025
        </h1>
        <p class="text-gray-600 text-lg">Join the ultimate technology competition and showcase your skills!</p>
    </div>

    <!-- Registration Form -->
    <div class="bg-white rounded-2xl shadow-xl p-8">
        <form method="post" class="space-y-6" id="registration-form" action="{% url 'register' %}">
            {% csrf_token %}
            {{ form.selected_events }}
            
            <!-- Personal Information Section -->
            <div class="border-b border-gray-200 pb-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-user text-blue-500 mr-2"></i>
                    Personal Information
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Full Name <span class="text-red-500">*</span>
                        </label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.name.errors.0 }}</div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Email Address <span class="text-red-500">*</span>
                        </label>
                        {{ form.email }}
                        {% if form.email.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.email.errors.0 }}</div>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">Participation certificate will be sent here</p>
                    </div>
                    
                    <div>
                        <label for="{{ form.mobile_number.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Mobile Number (WhatsApp) <span class="text-red-500">*</span>
                        </label>
                        {{ form.mobile_number }}
                        {% if form.mobile_number.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.mobile_number.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Academic Information Section -->
            <div class="border-b border-gray-200 pb-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-graduation-cap text-green-500 mr-2"></i>
                    Academic Information
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label for="{{ form.school_college.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            School/College Name <span class="text-red-500">*</span>
                        </label>
                        {{ form.school_college }}
                        {% if form.school_college.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.school_college.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="md:col-span-2" id="other_school_div" style="display: none;">
                        <label for="{{ form.other_school.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Other School/College Name <span class="text-red-500">*</span>
                        </label>
                        {{ form.other_school }}
                        {% if form.other_school.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.other_school.errors.0 }}</div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.grade.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Grade/Class <span class="text-red-500">*</span>
                        </label>
                        {{ form.grade }}
                        {% if form.grade.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.grade.errors.0 }}</div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Group (Auto-selected)
                        </label>
                        <div id="group-display"
                             hx-get="{% url 'get_group_for_grade' %}" 
                             hx-trigger="change from:#id_grade"
                             hx-include="#id_grade"
                             hx-target="this"
                             hx-swap="outerHTML"
                             class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500">
                            Select grade first
                        </div>
                    </div>
                    
                    <div>
                        <label for="{{ form.section.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Section
                        </label>
                        {{ form.section }}
                        {% if form.section.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.section.errors.0 }}</div>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">Only fill if you're from SJIS</p>
                    </div>
                    
                    <div>
                        <label for="{{ form.roll.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Roll Number/ID <span class="text-red-500">*</span>
                        </label>
                        {{ form.roll }}
                        {% if form.roll.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.roll.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Campus Ambassador Section -->
            <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 rounded-r-lg mb-6">
                <div class="flex">
                    <div class="py-1"><i class="fas fa-bullhorn fa-2x mr-4"></i></div>
                    <div>
                        <p class="font-bold">Are you a Campus Ambassador?</p>
                        <p class="text-sm">If you are, kindly complete the form by clicking the "Fill CA Form" button below.</p>
                        <a href="#" target="_blank" class="mt-2 inline-block bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition-colors">
                            Fill CA Form
                        </a>
                    </div>
                </div>
            </div>

            <!-- Event Selection Section -->
            <div class="pb-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-calendar-check text-purple-500 mr-2"></i>
                    Event Selection
                </h2>
                
                <div id="event-list" 
                     hx-get="{% url 'get_events_for_grade' %}" 
                     hx-trigger="change from:#id_grade" 
                     hx-include="#id_grade"
                     hx-target="this" 
                     hx-swap="innerHTML">
                    <div class="text-center py-8">
                        <div class="text-gray-400 text-lg">
                            <i class="fas fa-graduation-cap text-4xl mb-4 block text-gray-300"></i>
                            Please select your grade first to see available events
                        </div>
                        <p class="text-gray-400 text-sm mt-2">Events are filtered based on your grade level</p>
                    </div>
                </div>
                
                {% if form.selected_events.errors %}
                    <div class="text-red-500 text-sm mt-2">{{ form.selected_events.errors.0 }}</div>
                {% endif %}
                
                <!-- Total Amount Display -->
                <div class="mt-6 bg-gray-50 rounded-lg p-6 border-2 border-dashed border-gray-300">
                    <div class="text-center">
                        <h3 class="text-lg font-medium text-gray-700 mb-2">Total Amount to Pay</h3>
                        <div id="total-amount">
                            <div class="text-gray-500">à§³0</div>
                        </div>
                        <p class="text-sm text-gray-500 mt-2">Select events to see total amount</p>
                    </div>
                </div>
            </div>

            <!-- Form Errors -->
            {% if form.non_field_errors %}
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="text-red-700">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        {% for error in form.non_field_errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <!-- Submit Button -->
            <div class="flex justify-center pt-6">
                <button type="submit" id="submit-button" class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-4 px-8 rounded-xl text-lg transition-all transform hover:scale-105 shadow-lg">
                    <i class="fas fa-credit-card mr-2"></i>
                    Proceed to Payment
                </button>
            </div>
        </form>
    </div>

    <!-- Payment Info -->
    <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-blue-800 mb-4 flex items-center">
            <i class="fas fa-info-circle mr-2"></i>
            Payment Information
        </h3>
        <ul class="text-blue-700 space-y-2">
            <li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i>Secure payment via SSL Commerz</li>
            <li class="flex items-center"><i class="fas fa-mobile-alt text-green-500 mr-2"></i>Pay with bKash, Rocket, Nagad, or Card</li>
            <li class="flex items-center"><i class="fas fa-receipt text-green-500 mr-2"></i>Instant receipt generation</li>
            <li class="flex items-center"><i class="fas fa-envelope text-green-500 mr-2"></i>Email confirmation</li>
        </ul>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('registration-form');
        const submitButton = document.getElementById('submit-button');
        const eventList = document.getElementById('event-list');
        let validationInProgress = false;

        function updateSelectedEvents() {
            const checkboxes = form.querySelectorAll('.event-option-checkbox:checked');
            const hiddenInput = document.getElementById('id_selected_events');
            if (hiddenInput) {
                const selectedIds = Array.from(checkboxes).map(cb => cb.value);
                hiddenInput.value = selectedIds.join(',');
                console.log('Updated selected events:', selectedIds);
                return selectedIds.length > 0;
            }
            return false;
        }

        function updateTotal() {
            if (typeof htmx !== 'undefined') {
                htmx.ajax('POST', '{% url "calculate_total" %}', {
                    target: '#total-amount',
                    swap: 'innerHTML',
                    source: form
                });
            }
        }

        function showTeamSection(optionId) {
            const teamDetailsDiv = document.getElementById(`team-details-${optionId}`);
            if (teamDetailsDiv) teamDetailsDiv.classList.remove('hidden');
        }

        function hideTeamSection(optionId) {
            const teamDetailsDiv = document.getElementById(`team-details-${optionId}`);
            if (teamDetailsDiv) teamDetailsDiv.classList.add('hidden');
        }

        function addTeamMember(addButton) {
            const optionId = addButton.dataset.optionId;
            const maxTeamSize = parseInt(addButton.dataset.maxTeamSize, 10);
            const container = document.getElementById(`team-members-container-${optionId}`);
            const teamSizeInfo = document.getElementById(`team-size-info-${optionId}`);
            const currentMemberCount = container.children.length + 1;

            if (currentMemberCount < maxTeamSize) {
                const newMemberIndex = container.children.length + 1;
                const memberNumber = currentMemberCount + 1;
                const newMemberDiv = document.createElement('div');
                newMemberDiv.className = 'flex items-center space-x-2 mb-2 team-member-row';
                newMemberDiv.innerHTML = `
                    <div class="flex items-center flex-grow">
                        <input type="radio" name="team_leader_${optionId}" value="${newMemberIndex}" class="h-5 w-5 text-blue-600 border-gray-300 rounded-full focus:ring-blue-500">
                        <input type="text" name="team_member_${optionId}_${newMemberIndex}" class="w-full px-3 py-2 border border-gray-300 rounded-lg ml-2" placeholder="Team Member ${memberNumber} Name" required>
                    </div>
                    <button type="button" class="remove-team-member text-red-500 hover:text-red-700 font-bold text-xl p-1">&times;</button>
                `;
                container.appendChild(newMemberDiv);
                const remaining = maxTeamSize - (currentMemberCount + 1);
                teamSizeInfo.textContent = remaining > 0 ? `You can add ${remaining} more member(s).` : 'Maximum team size reached.';
                if (remaining <= 0) addButton.disabled = true;
            }
        }

        function removeTeamMember(removeButton) {
            const memberRow = removeButton.closest('.team-member-row');
            const container = memberRow.parentElement;
            const optionId = container.id.split('-')[3];
            const addButton = document.querySelector(`.add-team-member[data-option-id='${optionId}']`);
            const maxTeamSize = parseInt(addButton.dataset.maxTeamSize, 10);
            const teamSizeInfo = document.getElementById(`team-size-info-${optionId}`);
            memberRow.remove();
            const memberRows = container.querySelectorAll('.team-member-row');
            memberRows.forEach((row, index) => {
                const newMemberIndex = index + 1;
                const memberNumber = newMemberIndex + 1;
                row.querySelector('input[type="text"]').name = `team_member_${optionId}_${newMemberIndex}`;
                row.querySelector('input[type="text"]').placeholder = `Team Member ${memberNumber} Name`;
                row.querySelector('input[type="radio"]').value = `${newMemberIndex}`;
            });
            const currentMemberCount = container.children.length + 1;
            const remaining = maxTeamSize - currentMemberCount;
            teamSizeInfo.textContent = `You can add ${remaining} more member(s).`;
            addButton.disabled = false;
        }

        if (eventList) {
            eventList.addEventListener('change', function(e) {
                if (e.target.matches('.event-option-checkbox')) {
                    const checkbox = e.target;
                    const eventId = checkbox.dataset.eventId;
                    const optionType = checkbox.dataset.optionType;

                    if (checkbox.checked) {
                        eventList.querySelectorAll(`.event-option-checkbox[data-event-id="${eventId}"]`).forEach(cb => {
                            if (cb !== checkbox) {
                                if (cb.checked && cb.dataset.optionType === 'TEAM') hideTeamSection(cb.value);
                                cb.checked = false;
                            }
                        });
                    }

                    if (optionType === 'TEAM') {
                        if (checkbox.checked) showTeamSection(checkbox.value);
                        else hideTeamSection(checkbox.value);
                    }

                    updateSelectedEvents();
                    updateTotal();
                }
            });

            eventList.addEventListener('click', function(e) {
                if (e.target.matches('.add-team-member')) {
                    addTeamMember(e.target);
                } else if (e.target.matches('.remove-team-member')) {
                    removeTeamMember(e.target);
                }
            });
        }

        if (form) {
            form.addEventListener('submit', function (e) {
                if (validationInProgress) {
                    return; // Allow form submission if validation already passed
                }

                e.preventDefault(); // Prevent initial submission

                console.log('Form submission started');

                // Update selected events
                const hasEvents = updateSelectedEvents();
                console.log('Has events selected:', hasEvents);

                if (!hasEvents) {
                    alert('Please select at least one event.');
                    return;
                }

                // Validate team events
                const teamCheckboxes = form.querySelectorAll('.event-option-checkbox:checked[data-option-type="TEAM"]');
                for (const checkbox of teamCheckboxes) {
                    const optionId = checkbox.value;
                    const teamNameInput = form.querySelector(`input[name="team_name_${optionId}"]`);
                    if (!teamNameInput || !teamNameInput.value.trim()) {
                        const eventName = checkbox.closest('.event-section').querySelector('h3').textContent.trim();
                        alert(`Please enter a team name for the event: "${eventName}".`);
                        if (teamNameInput) teamNameInput.focus();
                        return;
                    }
                }

                // All validations passed
                validationInProgress = true;
                
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
                }
                
                console.log('Submitting form');
                form.submit();
            });
        }

        function initializeSchoolLogic() {
            const schoolDropdown = document.getElementById('id_school_college');
            const otherSchoolDiv = document.getElementById('other_school_div');
            if (schoolDropdown && otherSchoolDiv) {
                const otherSchoolInput = otherSchoolDiv.querySelector('input[name="other_school"]');
                const toggle = () => {
                    const isOther = schoolDropdown.value === '';
                    otherSchoolDiv.style.display = isOther ? 'block' : 'none';
                    if(otherSchoolInput) otherSchoolInput.required = isOther;
                };
                schoolDropdown.addEventListener('change', toggle);
                toggle();
            }
        }
        initializeSchoolLogic();

    });
</script>
{% endblock %}